{% extends "base.html" %}
{% block title %}HoPono Massage Studio — Relaxation & Wellness in Nicosia{% endblock %}

{% block content %}
<div x-data="homeBooking()">

    <!-- Hero Section — compact -->
    <section class="relative bg-hopono-blue-deeper overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-hopono-blue-deeper via-hopono-blue-dark to-hopono-blue opacity-90"></div>
        <div class="relative max-w-7xl mx-auto px-4 py-14 sm:py-20">
            <div class="text-center max-w-3xl mx-auto">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-heading font-light text-white leading-tight mb-3">
                    Massage is a <span class="text-hopono-gold font-medium">Journey</span>
                </h1>
                <p class="text-lg sm:text-xl text-white/70 font-light mb-6">
                    Professional massage therapy in the heart of Nicosia.
                </p>
                <a href="#book" @click.prevent="scrollToBooking()"
                   class="inline-block bg-hopono-gold hover:bg-hopono-gold-light text-hopono-blue-deeper font-semibold px-8 py-3 rounded-full text-lg transition transform hover:scale-105">
                    Book Your Session
                </a>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 right-0">
            <svg viewBox="0 0 1440 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M0,50 C360,80 720,20 1440,50 L1440,80 L0,80 Z" fill="white"/>
            </svg>
        </div>
    </section>

    <!-- Inline Booking Section -->
    <section id="book" class="py-12 sm:py-16 bg-white">
        <div class="max-w-5xl mx-auto px-4">

            <noscript>
                <div class="text-center py-8">
                    <p class="text-gray-600 mb-4">JavaScript is required for the booking calendar.</p>
                    <a href="{{ url_for('booking.select_service') }}" class="bg-hopono-gold hover:bg-hopono-gold-light text-hopono-blue-deeper font-semibold px-8 py-3 rounded-full transition inline-block">
                        Book via standard form
                    </a>
                </div>
            </noscript>

            <!-- Progress indicator -->
            <div class="flex items-center justify-center mb-10">
                <div class="flex items-center space-x-3 text-sm">
                    <span class="flex items-center" :class="step >= 1 ? 'text-hopono-blue font-semibold' : 'text-gray-400'">
                        <span class="w-7 h-7 rounded-full flex items-center justify-center mr-1.5 text-xs"
                              :class="step >= 1 ? 'bg-hopono-blue text-white' : 'bg-gray-200 text-gray-500'">1</span>
                        Treatment
                    </span>
                    <div class="w-8 h-px" :class="step >= 2 ? 'bg-hopono-blue' : 'bg-gray-200'"></div>
                    <span class="flex items-center" :class="step >= 2 ? 'text-hopono-blue font-semibold' : 'text-gray-400'">
                        <span class="w-7 h-7 rounded-full flex items-center justify-center mr-1.5 text-xs"
                              :class="step >= 2 ? 'bg-hopono-blue text-white' : 'bg-gray-200 text-gray-500'">2</span>
                        Date & Time
                    </span>
                    <div class="w-8 h-px" :class="step >= 3 ? 'bg-hopono-blue' : 'bg-gray-200'"></div>
                    <span class="flex items-center" :class="step >= 3 ? 'text-hopono-blue font-semibold' : 'text-gray-400'">
                        <span class="w-7 h-7 rounded-full flex items-center justify-center mr-1.5 text-xs"
                              :class="step >= 3 ? 'bg-hopono-blue text-white' : 'bg-gray-200 text-gray-500'">3</span>
                        Details
                    </span>
                </div>
            </div>

            <!-- Step 1: Service Selection -->
            <div x-show="step === 1" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">
                <h2 class="text-2xl sm:text-3xl font-heading font-semibold text-hopono-blue-deeper mb-2 text-center">
                    Choose Your Treatment
                </h2>
                <p class="text-gray-500 text-center mb-8 max-w-xl mx-auto">
                    Each treatment is crafted to restore balance, ease tension, and bring you back to a state of calm.
                </p>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for service in services %}
                    <button
                            x-data='{ svc: { id: {{ service.id }}, name: {{ service.name|tojson }}, dur: {{ service.duration_minutes }}, price: {{ service.price_eur }} } }'
                            @click="selectService(svc.id, svc.name, svc.dur, svc.price)"
                            class="text-left bg-hopono-cream rounded-xl p-6 border-2 transition duration-200 hover:shadow-lg group cursor-pointer"
                            :class="selectedServiceId === {{ service.id }} ? 'border-hopono-gold shadow-lg ring-2 ring-hopono-gold/20' : 'border-transparent hover:border-hopono-gold/30'">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h3 class="font-heading font-semibold text-hopono-blue-deeper text-lg">{{ service.name }}</h3>
                                <p class="text-hopono-gold text-sm font-medium">{{ service.subtitle }}</p>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-1 transition"
                                 :class="selectedServiceId === {{ service.id }} ? 'border-hopono-gold bg-hopono-gold' : 'border-gray-300'">
                                <svg x-show="selectedServiceId === {{ service.id }}" class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm leading-relaxed mb-4">{{ service.description[:100] }}{% if service.description|length > 100 %}...{% endif %}</p>
                        <div class="flex justify-between items-center pt-3 border-t border-gray-200/60">
                            <span class="text-hopono-blue font-semibold">&euro;{{ "%.0f"|format(service.price_eur) }}</span>
                            <span class="text-gray-400 text-sm">{{ service.duration_minutes }} min</span>
                        </div>
                    </button>
                    {% endfor %}
                </div>

                <div class="text-center mt-8">
                    <button @click="goToStep2()" :disabled="!selectedServiceId"
                            class="bg-hopono-blue hover:bg-hopono-blue-dark text-white font-semibold px-10 py-3 rounded-full transition disabled:opacity-40 disabled:cursor-not-allowed">
                        Continue
                    </button>
                </div>
            </div>

            <!-- Step 2: Date & Time -->
            <div x-show="step === 2" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">
                <div class="flex items-center justify-between mb-6">
                    <button @click="step = 1" class="text-hopono-blue hover:text-hopono-blue-dark font-medium transition text-sm">
                        &larr; Change treatment
                    </button>
                    <div class="bg-hopono-cream rounded-full px-4 py-1.5 text-sm">
                        <span class="font-semibold text-hopono-blue-deeper" x-text="selectedServiceName"></span>
                        <span class="text-gray-400 mx-1">&middot;</span>
                        <span class="text-gray-500"><span x-text="selectedDuration"></span> min</span>
                        <span class="text-gray-400 mx-1">&middot;</span>
                        <span class="text-hopono-blue font-semibold">&euro;<span x-text="selectedPrice"></span></span>
                    </div>
                </div>

                <h2 class="text-2xl font-heading font-semibold text-hopono-blue-deeper mb-6 text-center">
                    Pick a Date & Time
                </h2>

                <!-- Calendar -->
                <div class="max-w-md mx-auto mb-6">
                    <div class="bg-hopono-cream rounded-2xl p-5">
                        <div class="flex items-center justify-between mb-4">
                            <button @click="prevMonth()" class="text-hopono-blue hover:text-hopono-blue-dark p-1 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            </button>
                            <h3 class="font-heading font-semibold text-hopono-blue-deeper" x-text="calendarTitle"></h3>
                            <button @click="nextMonth()" class="text-hopono-blue hover:text-hopono-blue-dark p-1 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-400 mb-2">
                            <span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>
                        </div>
                        <div class="grid grid-cols-7 gap-1">
                            <template x-for="day in calendarDays" :key="day.key">
                                <button
                                    @click="day.selectable && selectDate(day.dateStr)"
                                    class="h-9 w-full rounded-lg text-sm font-medium transition"
                                    :class="{
                                        'text-transparent cursor-default': !day.inMonth,
                                        'text-gray-300 cursor-default': day.inMonth && !day.selectable,
                                        'text-hopono-blue-deeper hover:bg-hopono-gold/20 cursor-pointer': day.inMonth && day.selectable && selectedDate !== day.dateStr,
                                        'bg-hopono-blue text-white': selectedDate === day.dateStr,
                                    }"
                                    :disabled="!day.selectable"
                                    x-text="day.label">
                                </button>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Loading state -->
                <div x-show="loadingSlots" class="text-center mt-6">
                    <div class="inline-block animate-spin rounded-full h-7 w-7 border-b-2 border-hopono-blue"></div>
                    <p class="text-gray-500 mt-2 text-sm">Loading available times...</p>
                </div>

                <!-- Slots grid -->
                <div x-show="selectedDate && !loadingSlots && slots.length > 0" class="mt-6">
                    <p class="text-center text-gray-500 text-sm mb-3">Available times for <span x-text="formattedDate" class="font-semibold text-hopono-blue-deeper"></span></p>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 max-w-2xl mx-auto">
                        <template x-for="slot in slots" :key="slot">
                            <button @click="selectedTime = slot"
                                    class="py-2.5 px-3 rounded-lg text-center font-medium transition border-2 text-sm"
                                    :class="selectedTime === slot ? 'bg-hopono-blue text-white border-hopono-blue' : 'bg-white text-hopono-blue-deeper border-gray-200 hover:border-hopono-gold/40'">
                                <span x-text="slot"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- No slots -->
                <div x-show="selectedDate && !loadingSlots && slots.length === 0" class="text-center mt-6">
                    <p class="text-gray-400 text-sm">No available times for this date. Please choose another day.</p>
                </div>

                <div class="text-center mt-8">
                    <button @click="step = 3" :disabled="!selectedTime"
                            class="bg-hopono-blue hover:bg-hopono-blue-dark text-white font-semibold px-10 py-3 rounded-full transition disabled:opacity-40 disabled:cursor-not-allowed">
                        Continue
                    </button>
                </div>
            </div>

            <!-- Step 3: Client Details -->
            <div x-show="step === 3" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0">
                <div class="max-w-lg mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <button @click="step = 2" class="text-hopono-blue hover:text-hopono-blue-dark font-medium transition text-sm">
                            &larr; Change time
                        </button>
                    </div>

                    <!-- Summary -->
                    <div class="bg-hopono-cream rounded-xl p-5 mb-8">
                        <h3 class="font-heading font-semibold text-hopono-blue-deeper text-sm mb-3">Your Booking</h3>
                        <div class="text-sm text-gray-600 space-y-1.5">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Treatment</span>
                                <span class="font-medium text-hopono-blue-deeper" x-text="selectedServiceName"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Date</span>
                                <span class="font-medium text-hopono-blue-deeper" x-text="formattedDate"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Time</span>
                                <span class="font-medium text-hopono-blue-deeper" x-text="selectedTime"></span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-gray-200">
                                <span class="text-gray-400">Price</span>
                                <span class="font-semibold text-hopono-blue-deeper">
                                    &euro;<span x-text="selectedPrice"></span>
                                    <span x-show="discountAmount > 0" class="text-green-600 text-xs">
                                        (-&euro;<span x-text="discountAmount.toFixed(2)"></span>)
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <h2 class="text-xl font-heading font-semibold text-hopono-blue-deeper mb-4">
                        Almost there — your details
                    </h2>

                    <form method="POST" action="{{ url_for('booking.confirm') }}" class="space-y-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="service_id" :value="selectedServiceId">
                        <input type="hidden" name="date" :value="selectedDate">
                        <input type="hidden" name="start_time" :value="selectedTime">

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                                <input type="text" name="name" required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-hopono-blue focus:border-transparent text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                <input type="email" name="email" required
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-hopono-blue focus:border-transparent text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                                <input type="tel" name="phone" required placeholder="+357..."
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-hopono-blue focus:border-transparent text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Reminder Preference</label>
                            <select name="reminder_preference"
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-hopono-blue focus:border-transparent text-sm">
                                <option value="both">SMS & Email</option>
                                <option value="phone">SMS only</option>
                                <option value="email">Email only</option>
                            </select>
                        </div>

                        <!-- Coupon -->
                        <div x-data="{ showCoupon: false }">
                            <button type="button" @click="showCoupon = !showCoupon"
                                    class="text-xs text-gray-400 hover:text-hopono-blue transition">
                                Have a coupon code?
                            </button>
                            <div x-show="showCoupon" x-transition class="mt-2 flex gap-2">
                                <input type="text" name="coupon_code" x-model="couponCode" placeholder="Enter code"
                                       class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-hopono-blue focus:border-transparent">
                                <button type="button" @click="checkCoupon()"
                                        class="bg-hopono-cream text-hopono-blue-deeper px-4 py-2 rounded-lg text-sm font-medium hover:bg-hopono-gold/20 transition">
                                    Apply
                                </button>
                            </div>
                            <p x-show="couponMessage" x-text="couponMessage" class="text-xs mt-1"
                               :class="couponValid ? 'text-green-600' : 'text-red-500'"></p>
                        </div>

                        <!-- GDPR -->
                        <div class="pt-3 border-t border-gray-200">
                            <label class="flex items-start space-x-3">
                                <input type="checkbox" required
                                       class="mt-0.5 rounded border-gray-300 text-hopono-blue focus:ring-hopono-blue">
                                <span class="text-xs text-gray-500 leading-relaxed">
                                    I consent to HoPono Massage storing my personal data for managing my appointment
                                    and sending reminders, in accordance with GDPR. *
                                </span>
                            </label>
                        </div>

                        <button type="submit"
                                class="w-full bg-hopono-gold hover:bg-hopono-gold-light text-hopono-blue-deeper font-semibold py-3 rounded-full text-lg transition transform hover:scale-[1.02]">
                            Confirm Booking
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- About Preview — kept for the studio feel -->
    <section class="py-16 bg-hopono-cream">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                <div>
                    <h2 class="text-2xl sm:text-3xl font-heading font-semibold text-hopono-blue-deeper mb-5">
                        Your Wellness, Our Passion
                    </h2>
                    <p class="text-gray-600 leading-relaxed mb-4">
                        At HoPono, we believe that massage is more than just a treatment &mdash; it's an
                        experience that nurtures body, mind, and spirit.
                    </p>
                    <p class="text-gray-600 leading-relaxed mb-5 text-sm">
                        Our therapist Evthoras brings years of experience and a deep understanding of
                        various massage traditions, from Indian Ayurveda to Thai and Chinese techniques.
                    </p>
                    <a href="{{ url_for('public.about') }}"
                       class="inline-block text-hopono-blue hover:text-hopono-blue-dark font-semibold transition text-sm">
                        Learn more about us &rarr;
                    </a>
                </div>
                <div class="bg-gradient-to-br from-hopono-blue to-hopono-blue-dark rounded-2xl p-10 text-center">
                    <blockquote class="text-white text-lg italic font-light leading-relaxed">
                        &ldquo;It is my pleasure to be a part of your journey towards wellness.&rdquo;
                    </blockquote>
                    <p class="text-hopono-gold mt-3 font-heading font-medium">&mdash; Evthoras</p>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
function homeBooking() {
    return {
        step: 1,
        selectedServiceId: null,
        selectedServiceName: '',
        selectedDuration: 0,
        selectedPrice: 0,
        selectedDate: '',
        selectedTime: '',
        slots: [],
        loadingSlots: false,
        couponCode: '',
        couponMessage: '',
        couponValid: false,
        discountAmount: 0,

        calMonth: new Date().getMonth(),
        calYear: new Date().getFullYear(),

        get calendarTitle() {
            return new Date(this.calYear, this.calMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        },

        get calendarDays() {
            const first = new Date(this.calYear, this.calMonth, 1);
            const lastDay = new Date(this.calYear, this.calMonth + 1, 0).getDate();
            let startDay = first.getDay() - 1;
            if (startDay < 0) startDay = 6;

            const today = new Date();
            today.setHours(0,0,0,0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const days = [];
            const prevMonthLast = new Date(this.calYear, this.calMonth, 0).getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                days.push({ label: prevMonthLast - i, inMonth: false, selectable: false, dateStr: '', key: 'p' + i });
            }
            for (let d = 1; d <= lastDay; d++) {
                const date = new Date(this.calYear, this.calMonth, d);
                const dateStr = date.getFullYear() + '-' + String(date.getMonth()+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
                days.push({
                    label: d,
                    inMonth: true,
                    selectable: date >= tomorrow,
                    dateStr: dateStr,
                    key: dateStr
                });
            }
            const remaining = 7 - (days.length % 7);
            if (remaining < 7) {
                for (let i = 1; i <= remaining; i++) {
                    days.push({ label: i, inMonth: false, selectable: false, dateStr: '', key: 'n' + i });
                }
            }
            return days;
        },

        get formattedDate() {
            if (!this.selectedDate) return '';
            const d = new Date(this.selectedDate + 'T00:00:00');
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });
        },

        prevMonth() {
            if (this.calMonth === 0) { this.calMonth = 11; this.calYear--; }
            else { this.calMonth--; }
            this.selectedDate = '';
            this.selectedTime = '';
            this.slots = [];
        },

        nextMonth() {
            if (this.calMonth === 11) { this.calMonth = 0; this.calYear++; }
            else { this.calMonth++; }
            this.selectedDate = '';
            this.selectedTime = '';
            this.slots = [];
        },

        scrollToBooking() {
            document.getElementById('book').scrollIntoView({ behavior: 'smooth' });
        },

        selectService(id, name, duration, price) {
            this.selectedServiceId = id;
            this.selectedServiceName = name;
            this.selectedDuration = duration;
            this.selectedPrice = price;
        },

        goToStep2() {
            if (this.selectedServiceId) {
                this.step = 2;
                this.selectedDate = '';
                this.selectedTime = '';
                this.slots = [];
                this.$nextTick(() => {
                    document.getElementById('book').scrollIntoView({ behavior: 'smooth' });
                });
            }
        },

        selectDate(dateStr) {
            this.selectedDate = dateStr;
            this.fetchSlots();
        },

        async fetchSlots() {
            if (!this.selectedDate || !this.selectedServiceId) return;
            this.loadingSlots = true;
            this.selectedTime = '';
            try {
                const resp = await fetch(`/book/slots?service_id=${this.selectedServiceId}&date=${this.selectedDate}`);
                const data = await resp.json();
                this.slots = data.slots || [];
            } catch (e) {
                this.slots = [];
            }
            this.loadingSlots = false;
        },

        async checkCoupon() {
            if (!this.couponCode) return;
            try {
                const resp = await fetch('/book/validate-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrf_token]').value
                    },
                    body: JSON.stringify({
                        code: this.couponCode,
                        service_id: this.selectedServiceId
                    })
                });
                const data = await resp.json();
                this.couponMessage = data.message;
                this.couponValid = data.valid;
                this.discountAmount = data.valid ? data.discount_amount : 0;
            } catch (e) {
                this.couponMessage = 'Error validating coupon.';
                this.couponValid = false;
            }
        }
    }
}
</script>
{% endblock %}
