{% extends "admin/base_admin.html" %}
{% block title %}New Booking{% endblock %}
{% block page_title %}Add Manual Booking{% endblock %}

{% block admin_content %}
<div class="max-w-2xl" x-data="manualBooking()">
    <div class="bg-white rounded-xl border border-gray-200 p-6">
        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Service</label>
                    <select name="service_id" x-model="serviceId" @change="fetchSlots()" required
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">Select service...</option>
                        {% for service in services %}
                        <option value="{{ service.id }}">{{ service.name }} ({{ service.duration_minutes }}min â€” &euro;{{ "%.0f"|format(service.price_eur) }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" name="date" x-model="bookingDate" @change="fetchSlots()" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                    <select name="start_time" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="">Select time...</option>
                        <template x-for="slot in slots" :key="slot">
                            <option :value="slot" x-text="slot"></option>
                        </template>
                    </select>
                    <p x-show="serviceId && bookingDate && slots.length === 0" class="text-red-500 text-xs mt-1">
                        No slots available for this date.
                    </p>
                </div>
            </div>

            <h3 class="font-semibold text-gray-800 mb-3">Client Details</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" name="name" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="tel" name="phone" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reminder</label>
                    <select name="reminder_preference" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="email" selected>Email only</option>
                        <option value="both">SMS & Email</option>
                        <option value="phone">SMS only</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <a href="{{ url_for('admin_bookings.list_bookings') }}" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">Cancel</a>
                <button type="submit" class="bg-hopono-blue text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-hopono-blue-dark transition">
                    Create Booking
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block admin_scripts %}
<script>
function manualBooking() {
    return {
        serviceId: '',
        bookingDate: '',
        slots: [],
        async fetchSlots() {
            if (!this.serviceId || !this.bookingDate) { this.slots = []; return; }
            try {
                const resp = await fetch(`/book/slots?service_id=${this.serviceId}&date=${this.bookingDate}`);
                const data = await resp.json();
                this.slots = data.slots || [];
            } catch (e) { this.slots = []; }
        }
    }
}
</script>
{% endblock %}
