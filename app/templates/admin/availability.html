{% extends "admin/base_admin.html" %}
{% block title %}Availability{% endblock %}
{% block page_title %}Availability{% endblock %}

{% block admin_content %}
<div x-data="availabilityManager()" x-init="init()">

    <!-- View Toggle -->
    <div class="flex items-center justify-center mb-4">
        <div class="inline-flex bg-gray-100 rounded-xl p-1">
            <button @click="setView('week')"
                    class="px-5 py-1.5 rounded-lg text-sm font-medium transition-all duration-150 touch-manipulation"
                    :class="view === 'week' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500'">
                Week
            </button>
            <button @click="setView('month')"
                    class="px-5 py-1.5 rounded-lg text-sm font-medium transition-all duration-150 touch-manipulation"
                    :class="view === 'month' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500'">
                Month
            </button>
        </div>
    </div>

    <!-- ═══════════════════════════════════════════ -->
    <!--  WEEK VIEW                                  -->
    <!-- ═══════════════════════════════════════════ -->
    <div x-show="view === 'week'" x-cloak>

        <!-- Week Navigation -->
        <div class="flex items-center justify-between mb-4">
            <button @click="prevWeek()" class="p-2 rounded-lg bg-white border border-gray-200 active:bg-gray-100 touch-manipulation">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <div class="text-center">
                <button @click="goToday()" class="text-xs text-hopono-blue font-medium mb-0.5 block">Today</button>
                <h2 class="text-sm font-semibold text-gray-800" x-text="weekLabel"></h2>
            </div>
            <button @click="nextWeek()" class="p-2 rounded-lg bg-white border border-gray-200 active:bg-gray-100 touch-manipulation">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-hopono-blue"></div>
        </div>

        <!-- Day Cards -->
        <div x-show="!loading" class="space-y-2">
            <template x-for="day in weekDays" :key="day.dateStr">
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden"
                     :class="day.isToday ? 'ring-2 ring-hopono-blue/30' : ''">

                    <!-- Day Header -->
                    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div class="text-center w-10">
                                <div class="text-[10px] uppercase font-semibold tracking-wide"
                                     :class="day.isToday ? 'text-hopono-blue' : 'text-gray-400'"
                                     x-text="day.dayShort"></div>
                                <div class="text-lg font-bold leading-tight"
                                     :class="day.isToday ? 'text-hopono-blue' : 'text-gray-800'"
                                     x-text="day.dayNum"></div>
                            </div>
                            <div>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full"
                                      :class="day.windows.length > 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'"
                                      x-text="day.windows.length > 0 ? 'Available' : 'Off'"></span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1">
                            <button @click="quickAdd(day.dateStr, '10:00', '18:00')"
                                    x-show="day.windows.length === 0"
                                    class="text-[10px] font-semibold px-2.5 py-1.5 rounded-lg bg-hopono-blue/10 text-hopono-blue active:bg-hopono-blue/20 touch-manipulation whitespace-nowrap">
                                + Full day
                            </button>
                            <button @click="toggleCustom(day.dateStr)"
                                    class="p-2 rounded-lg text-gray-400 hover:text-hopono-blue active:bg-gray-100 touch-manipulation">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Windows List -->
                    <div x-show="day.windows.length > 0" class="px-4 py-2 space-y-1.5">
                        <template x-for="win in day.windows" :key="win.id">
                            <div class="flex items-center justify-between py-1.5 group">
                                <div class="flex items-center space-x-2">
                                    <div class="w-1 h-6 rounded-full bg-hopono-blue"></div>
                                    <span class="text-sm font-medium text-gray-700" x-text="win.start_time + ' – ' + win.end_time"></span>
                                </div>
                                <button @click="deleteWindow(win.id, day.dateStr)"
                                        class="p-1.5 rounded-lg text-gray-300 hover:text-red-500 active:bg-red-50 touch-manipulation">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                        </template>
                    </div>

                    <!-- Custom Time Picker (inline) -->
                    <div x-show="customDay === day.dateStr" x-transition class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                        <div class="text-xs font-medium text-gray-500 mb-2">Quick presets</div>
                        <div class="flex flex-wrap gap-1.5 mb-3">
                            <button @click="quickAdd(day.dateStr, '09:00', '17:00')" class="text-xs px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 active:bg-hopono-blue/10 touch-manipulation">9–17</button>
                            <button @click="quickAdd(day.dateStr, '10:00', '18:00')" class="text-xs px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 active:bg-hopono-blue/10 touch-manipulation">10–18</button>
                            <button @click="quickAdd(day.dateStr, '10:00', '14:00')" class="text-xs px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 active:bg-hopono-blue/10 touch-manipulation">10–14</button>
                            <button @click="quickAdd(day.dateStr, '14:00', '20:00')" class="text-xs px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 active:bg-hopono-blue/10 touch-manipulation">14–20</button>
                            <button @click="quickAdd(day.dateStr, '12:00', '20:00')" class="text-xs px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 active:bg-hopono-blue/10 touch-manipulation">12–20</button>
                        </div>
                        <div class="text-xs font-medium text-gray-500 mb-2">Custom</div>
                        <div class="flex items-center space-x-2">
                            <input type="time" x-model="customStart" value="10:00"
                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm touch-manipulation">
                            <span class="text-gray-400 text-sm">to</span>
                            <input type="time" x-model="customEnd" value="18:00"
                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm touch-manipulation">
                            <button @click="addCustom(day.dateStr)"
                                    class="bg-hopono-blue text-white px-4 py-2 rounded-lg text-sm font-medium active:bg-hopono-blue-dark touch-manipulation whitespace-nowrap">
                                Add
                            </button>
                        </div>
                        <p x-show="customError" x-text="customError" class="text-xs text-red-500 mt-1"></p>
                    </div>
                </div>
            </template>
        </div>

        <!-- Bottom Actions -->
        <div x-show="!loading" class="mt-4 space-y-2">
            <div class="flex space-x-2">
                <button @click="copyToNextWeek()"
                        class="flex-1 bg-white border border-gray-200 text-gray-700 font-medium py-3 rounded-xl text-sm active:bg-gray-50 touch-manipulation"
                        :disabled="copyingWeek">
                    <span x-show="!copyingWeek">Copy to next week</span>
                    <span x-show="copyingWeek" class="text-gray-400">Copying...</span>
                </button>
                <button @click="clearWeek()"
                        class="bg-white border border-gray-200 text-red-500 font-medium py-3 px-5 rounded-xl text-sm active:bg-red-50 touch-manipulation">
                    Clear
                </button>
            </div>
        </div>

    </div><!-- /week view -->

    <!-- ═══════════════════════════════════════════ -->
    <!--  MONTH VIEW                                 -->
    <!-- ═══════════════════════════════════════════ -->
    <div x-show="view === 'month'" x-cloak>

        <!-- Month Navigation -->
        <div class="flex items-center justify-between mb-4">
            <button @click="prevMonth()" class="p-2 rounded-lg bg-white border border-gray-200 active:bg-gray-100 touch-manipulation">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <div class="text-center">
                <button @click="goThisMonth()" class="text-xs text-hopono-blue font-medium mb-0.5 block">Today</button>
                <h2 class="text-sm font-semibold text-gray-800" x-text="monthLabel"></h2>
            </div>
            <button @click="nextMonth()" class="p-2 rounded-lg bg-white border border-gray-200 active:bg-gray-100 touch-manipulation">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-hopono-blue"></div>
        </div>

        <!-- Calendar Grid -->
        <div x-show="!loading" class="bg-white rounded-xl border border-gray-200 overflow-hidden">

            <!-- Day-of-week Headers -->
            <div class="grid grid-cols-7 border-b border-gray-100">
                <template x-for="h in ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']" :key="h">
                    <div class="text-center py-2 text-[10px] font-semibold uppercase tracking-wide text-gray-400" x-text="h"></div>
                </template>
            </div>

            <!-- Day Cells -->
            <div class="grid grid-cols-7">
                <template x-for="(cell, idx) in monthGrid" :key="idx">
                    <div>
                        <!-- Empty padding cell -->
                        <div x-show="cell.isEmpty" class="aspect-square"></div>

                        <!-- Real day cell -->
                        <button x-show="!cell.isEmpty"
                                @click="jumpToWeek(cell.dateStr)"
                                class="w-full aspect-square flex flex-col items-center justify-center relative touch-manipulation transition-all duration-100 active:scale-95"
                                :class="{
                                    'bg-green-50': cell.count > 0 && !cell.isToday,
                                    'bg-hopono-blue': cell.isToday,
                                    'hover:bg-gray-50': cell.count === 0 && !cell.isToday
                                }">

                            <!-- Date number -->
                            <span class="text-sm font-semibold leading-none"
                                  :class="{
                                      'text-white': cell.isToday,
                                      'text-green-700': cell.count > 0 && !cell.isToday,
                                      'text-gray-300': cell.count === 0 && !cell.isToday
                                  }"
                                  x-text="cell.dayNum"></span>

                            <!-- Availability dot -->
                            <div x-show="cell.count > 0 && !cell.isToday"
                                 class="w-1 h-1 rounded-full bg-green-400 mt-1"></div>
                            <div x-show="cell.isToday && cell.count > 0"
                                 class="w-1 h-1 rounded-full bg-white/70 mt-1"></div>
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Legend -->
        <div x-show="!loading" class="flex items-center justify-center space-x-5 mt-3 text-xs text-gray-400">
            <div class="flex items-center space-x-1.5">
                <div class="w-3 h-3 rounded bg-green-50 border border-green-200"></div>
                <span>Available</span>
            </div>
            <div class="flex items-center space-x-1.5">
                <div class="w-3 h-3 rounded bg-white border border-gray-200"></div>
                <span>Off</span>
            </div>
            <div class="flex items-center space-x-1.5">
                <div class="w-3 h-3 rounded bg-hopono-blue"></div>
                <span>Today</span>
            </div>
        </div>

        <!-- Month Bottom Actions -->
        <div x-show="!loading" class="mt-4">
            <button @click="copyToNextMonth()"
                    class="w-full bg-white border border-gray-200 text-gray-700 font-medium py-3 rounded-xl text-sm active:bg-gray-50 touch-manipulation"
                    :disabled="copyingMonth">
                <span x-show="!copyingMonth">Copy month to next month</span>
                <span x-show="copyingMonth" class="text-gray-400">Copying...</span>
            </button>
        </div>

    </div><!-- /month view -->

    <!-- Global Status Message -->
    <p x-show="statusMsg" x-text="statusMsg"
       x-transition
       class="text-center text-xs text-green-600 font-medium py-2 mt-2"></p>

</div>
{% endblock %}

{% block admin_scripts %}
<style>
    [x-cloak] { display: none !important; }
</style>
<script>
function availabilityManager() {
    return {
        view: localStorage.getItem('avail_view') || 'week',
        loading: false,
        statusMsg: '',
        today: new Date().toISOString().split('T')[0],

        weekStart: null,
        weekDays: [],
        customDay: null,
        customStart: '10:00',
        customEnd: '18:00',
        customError: '',
        copyingWeek: false,

        monthYear: new Date().getFullYear(),
        monthNum: new Date().getMonth() + 1,
        monthGrid: [],
        copyingMonth: false,

        init() {
            if (this.view === 'week') {
                this.weekStart = this.mondayOf(new Date());
                this.loadWeek();
            } else {
                this.loadMonth();
            }
        },

        setView(v) {
            this.view = v;
            localStorage.setItem('avail_view', v);
            if (v === 'week') {
                if (!this.weekStart) this.weekStart = this.mondayOf(new Date());
                this.loadWeek();
            } else {
                if (this.weekStart) {
                    const d = new Date(this.weekStart + 'T00:00:00');
                    this.monthYear = d.getFullYear();
                    this.monthNum = d.getMonth() + 1;
                }
                this.loadMonth();
            }
        },

        // ─── WEEK VIEW ─────────────────────────────────────────────────────

        get weekLabel() {
            if (!this.weekStart) return '';
            const s = new Date(this.weekStart + 'T00:00:00');
            const e = new Date(s);
            e.setDate(e.getDate() + 6);
            const opts = { month: 'short', day: 'numeric' };
            const sameMonth = s.getMonth() === e.getMonth();
            if (sameMonth) {
                return s.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }) + ' – ' + e.getDate() + ', ' + s.getFullYear();
            }
            return s.toLocaleDateString('en-US', opts) + ' – ' + e.toLocaleDateString('en-US', opts) + ', ' + e.getFullYear();
        },

        mondayOf(d) {
            const dt = new Date(d);
            const day = dt.getDay();
            const diff = dt.getDate() - day + (day === 0 ? -6 : 1);
            dt.setDate(diff);
            return dt.toISOString().split('T')[0];
        },

        prevWeek() {
            const d = new Date(this.weekStart + 'T00:00:00');
            d.setDate(d.getDate() - 7);
            this.weekStart = d.toISOString().split('T')[0];
            this.loadWeek();
        },

        nextWeek() {
            const d = new Date(this.weekStart + 'T00:00:00');
            d.setDate(d.getDate() + 7);
            this.weekStart = d.toISOString().split('T')[0];
            this.loadWeek();
        },

        goToday() {
            this.weekStart = this.mondayOf(new Date());
            this.loadWeek();
        },

        async loadWeek() {
            if (!this.weekStart) {
                this.weekStart = this.mondayOf(new Date());
            }
            this.loading = true;
            this.customDay = null;
            try {
                const resp = await fetch(`/admin/availability/api/week?start=${this.weekStart}`);
                const data = await resp.json();
                const today = this.today;
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                this.weekDays = Object.entries(data.days).sort().map(([dateStr, windows], i) => {
                    const d = new Date(dateStr + 'T00:00:00');
                    return {
                        dateStr,
                        dayShort: dayNames[i],
                        dayNum: d.getDate(),
                        isToday: dateStr === today,
                        windows: windows,
                    };
                });
            } catch (e) {
                console.error('Failed to load week', e);
            }
            this.loading = false;
        },

        toggleCustom(dateStr) {
            this.customDay = this.customDay === dateStr ? null : dateStr;
            this.customError = '';
            this.customStart = '10:00';
            this.customEnd = '18:00';
        },

        async quickAdd(dateStr, start, end) {
            await this.addWindow(dateStr, start, end);
        },

        async addCustom(dateStr) {
            this.customError = '';
            if (!this.customStart || !this.customEnd) {
                this.customError = 'Please set both start and end times';
                return;
            }
            if (this.customStart >= this.customEnd) {
                this.customError = 'Start must be before end';
                return;
            }
            await this.addWindow(dateStr, this.customStart, this.customEnd);
            this.customDay = null;
        },

        async addWindow(dateStr, start, end) {
            try {
                const resp = await fetch('/admin/availability/api/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCsrf() },
                    body: JSON.stringify({ date: dateStr, start_time: start, end_time: end })
                });
                const data = await resp.json();
                if (resp.ok) {
                    const day = this.weekDays.find(d => d.dateStr === dateStr);
                    if (day) {
                        day.windows.push(data);
                        day.windows.sort((a, b) => a.start_time.localeCompare(b.start_time));
                    }
                    this.flash('Added ' + start + '–' + end);
                } else {
                    this.customError = data.error || 'Failed to add';
                }
            } catch (e) {
                this.customError = 'Network error';
            }
        },

        async deleteWindow(id, dateStr) {
            try {
                const resp = await fetch('/admin/availability/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCsrf() },
                    body: JSON.stringify({ id })
                });
                if (resp.ok) {
                    const day = this.weekDays.find(d => d.dateStr === dateStr);
                    if (day) {
                        day.windows = day.windows.filter(w => w.id !== id);
                    }
                    this.flash('Removed');
                } else {
                    const data = await resp.json();
                    this.flash(data.error || 'Failed to remove');
                }
            } catch (e) {
                this.flash('Network error');
            }
        },

        async copyToNextWeek() {
            this.copyingWeek = true;
            try {
                const nextStart = new Date(this.weekStart + 'T00:00:00');
                nextStart.setDate(nextStart.getDate() + 7);
                const targetStr = nextStart.toISOString().split('T')[0];
                const resp = await fetch('/admin/availability/api/copy-week', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCsrf() },
                    body: JSON.stringify({ source_start: this.weekStart, target_start: targetStr })
                });
                const data = await resp.json();
                if (resp.ok) {
                    this.flash('Copied ' + data.copied + ' windows to next week');
                } else {
                    this.flash(data.error || 'Copy failed');
                }
            } catch (e) {
                this.flash('Copy failed — network error');
            }
            this.copyingWeek = false;
        },

        async clearWeek() {
            if (!confirm('Clear all availability for this week?')) return;
            for (const day of this.weekDays) {
                if (day.windows.length > 0) {
                    await fetch('/admin/availability/api/clear-day', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCsrf() },
                        body: JSON.stringify({ date: day.dateStr })
                    });
                    day.windows = [];
                }
            }
            this.flash('Week cleared');
        },

        // ─── MONTH VIEW ────────────────────────────────────────────────────

        get monthLabel() {
            const d = new Date(this.monthYear, this.monthNum - 1, 1);
            return d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        },

        prevMonth() {
            if (this.monthNum === 1) { this.monthNum = 12; this.monthYear--; }
            else { this.monthNum--; }
            this.loadMonth();
        },

        nextMonth() {
            if (this.monthNum === 12) { this.monthNum = 1; this.monthYear++; }
            else { this.monthNum++; }
            this.loadMonth();
        },

        goThisMonth() {
            const now = new Date();
            this.monthYear = now.getFullYear();
            this.monthNum = now.getMonth() + 1;
            this.loadMonth();
        },

        async loadMonth() {
            this.loading = true;
            try {
                const resp = await fetch(`/admin/availability/api/month?year=${this.monthYear}&month=${this.monthNum}`);
                const data = await resp.json();
                this.buildMonthGrid(data.days);
            } catch (e) {
                console.error('Failed to load month', e);
            }
            this.loading = false;
        },

        buildMonthGrid(days) {
            const firstDay = new Date(this.monthYear, this.monthNum - 1, 1);
            const daysInMonth = new Date(this.monthYear, this.monthNum, 0).getDate();
            const startDow = (firstDay.getDay() + 6) % 7; // Mon=0 ... Sun=6
            const today = this.today;
            const grid = [];

            for (let i = 0; i < startDow; i++) {
                grid.push({ isEmpty: true });
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dt = new Date(this.monthYear, this.monthNum - 1, d);
                const dateStr = dt.toISOString().split('T')[0];
                grid.push({
                    isEmpty: false,
                    dateStr,
                    dayNum: d,
                    count: days[dateStr] ? days[dateStr].count : 0,
                    isToday: dateStr === today,
                });
            }

            const trailing = (7 - (grid.length % 7)) % 7;
            for (let i = 0; i < trailing; i++) {
                grid.push({ isEmpty: true });
            }

            this.monthGrid = grid;
        },

        jumpToWeek(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            this.monthYear = d.getFullYear();
            this.monthNum = d.getMonth() + 1;
            this.weekStart = this.mondayOf(d);
            this.view = 'week';
            localStorage.setItem('avail_view', 'week');
            this.loadWeek();
        },

        async copyToNextMonth() {
            this.copyingMonth = true;
            let targetYear = this.monthYear;
            let targetMonth = this.monthNum + 1;
            if (targetMonth > 12) { targetMonth = 1; targetYear++; }
            try {
                const resp = await fetch('/admin/availability/api/copy-month', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCsrf() },
                    body: JSON.stringify({
                        source_year: this.monthYear,
                        source_month: this.monthNum,
                        target_year: targetYear,
                        target_month: targetMonth
                    })
                });
                const data = await resp.json();
                if (resp.ok) {
                    this.flash('Copied ' + data.copied + ' windows to next month');
                } else {
                    this.flash(data.error || 'Copy failed');
                }
            } catch (e) {
                this.flash('Copy failed — network error');
            }
            this.copyingMonth = false;
        },

        // ─── SHARED HELPERS ────────────────────────────────────────────────

        flash(msg) {
            this.statusMsg = msg;
            setTimeout(() => { this.statusMsg = ''; }, 3000);
        },

        getCsrf() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        }
    };
}
</script>
{% endblock %}
