{% extends "base.html" %}
{% block title %}Book an Appointment â€” HoPono Massage{% endblock %}

{% block content %}
<section class="bg-gradient-to-br from-hopono-blue-deeper to-hopono-blue py-16">
    <div class="max-w-4xl mx-auto px-4 text-center">
        <h1 class="text-3xl sm:text-4xl font-heading font-light text-white mb-2">Book Your Session</h1>
        <p class="text-white/70">Choose your treatment to get started</p>
    </div>
</section>

<section class="py-16 bg-white" x-data="bookingApp()">
    <div class="max-w-4xl mx-auto px-4">

        <!-- Progress Steps -->
        <div class="flex items-center justify-center mb-12">
            <div class="flex items-center space-x-4 text-sm">
                <span class="flex items-center" :class="step >= 1 ? 'text-hopono-blue font-semibold' : 'text-gray-400'">
                    <span class="w-8 h-8 rounded-full flex items-center justify-center mr-2"
                          :class="step >= 1 ? 'bg-hopono-blue text-white' : 'bg-gray-200 text-gray-500'">1</span>
                    Service
                </span>
                <div class="w-12 h-px" :class="step >= 2 ? 'bg-hopono-blue' : 'bg-gray-200'"></div>
                <span class="flex items-center" :class="step >= 2 ? 'text-hopono-blue font-semibold' : 'text-gray-400'">
                    <span class="w-8 h-8 rounded-full flex items-center justify-center mr-2"
                          :class="step >= 2 ? 'bg-hopono-blue text-white' : 'bg-gray-200 text-gray-500'">2</span>
                    Date & Time
                </span>
                <div class="w-12 h-px" :class="step >= 3 ? 'bg-hopono-blue' : 'bg-gray-200'"></div>
                <span class="flex items-center" :class="step >= 3 ? 'text-hopono-blue font-semibold' : 'text-gray-400'">
                    <span class="w-8 h-8 rounded-full flex items-center justify-center mr-2"
                          :class="step >= 3 ? 'bg-hopono-blue text-white' : 'bg-gray-200 text-gray-500'">3</span>
                    Your Details
                </span>
            </div>
        </div>

        <!-- Step 1: Service Selection -->
        <div x-show="step === 1" x-transition>
            <h2 class="text-2xl font-heading font-semibold text-hopono-blue-deeper mb-6 text-center">
                Select Your Treatment
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {% for service in services %}
                <button @click="selectService({{ service.id }}, '{{ service.name }}', {{ service.duration_minutes }}, {{ service.price_eur }})"
                        class="text-left bg-hopono-cream rounded-xl p-6 border-2 transition hover:shadow-md"
                        :class="selectedServiceId === {{ service.id }} ? 'border-hopono-gold shadow-md' : 'border-transparent hover:border-hopono-gold/30'">
                    <h3 class="font-heading font-semibold text-hopono-blue-deeper">{{ service.name }}</h3>
                    <p class="text-hopono-gold text-sm font-medium">{{ service.subtitle }}</p>
                    <div class="flex justify-between items-center mt-3 text-sm">
                        <span class="text-hopono-blue font-semibold">&euro;{{ "%.0f"|format(service.price_eur) }}</span>
                        <span class="text-gray-400">{{ service.duration_minutes }} min</span>
                    </div>
                </button>
                {% endfor %}
            </div>
            <div class="text-center mt-8">
                <button @click="goToStep2()" :disabled="!selectedServiceId"
                        class="bg-hopono-blue hover:bg-hopono-blue-dark text-white font-semibold px-8 py-3 rounded-full transition disabled:opacity-40 disabled:cursor-not-allowed">
                    Continue
                </button>
            </div>
        </div>

        <!-- Step 2: Date & Time -->
        <div x-show="step === 2" x-transition>
            <h2 class="text-2xl font-heading font-semibold text-hopono-blue-deeper mb-6 text-center">
                Choose Your Date & Time
            </h2>
            <div class="max-w-md mx-auto">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Date</label>
                <input type="date" x-model="selectedDate" @change="fetchSlots()"
                       :min="minDate"
                       class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-blue focus:border-transparent">
            </div>

            <!-- Loading state -->
            <div x-show="loadingSlots" class="text-center mt-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-hopono-blue"></div>
                <p class="text-gray-500 mt-2">Loading available times...</p>
            </div>

            <!-- Slots grid -->
            <div x-show="selectedDate && !loadingSlots && slots.length > 0" class="mt-8">
                <p class="text-center text-gray-600 mb-4">Available times for <span x-text="selectedDate" class="font-semibold"></span></p>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 max-w-2xl mx-auto">
                    <template x-for="slot in slots" :key="slot">
                        <button @click="selectedTime = slot"
                                class="py-3 px-4 rounded-lg text-center font-medium transition border-2"
                                :class="selectedTime === slot ? 'bg-hopono-blue text-white border-hopono-blue' : 'bg-hopono-cream text-hopono-blue-deeper border-transparent hover:border-hopono-gold/30'">
                            <span x-text="slot"></span>
                        </button>
                    </template>
                </div>
            </div>

            <!-- No slots -->
            <div x-show="selectedDate && !loadingSlots && slots.length === 0" class="text-center mt-8">
                <p class="text-gray-500">No available times for this date. Please try another day.</p>
            </div>

            <div class="flex justify-between mt-8 max-w-md mx-auto">
                <button @click="step = 1" class="text-hopono-blue hover:text-hopono-blue-dark font-medium transition">
                    &larr; Back
                </button>
                <button @click="step = 3" :disabled="!selectedTime"
                        class="bg-hopono-blue hover:bg-hopono-blue-dark text-white font-semibold px-8 py-3 rounded-full transition disabled:opacity-40 disabled:cursor-not-allowed">
                    Continue
                </button>
            </div>
        </div>

        <!-- Step 3: Client Details -->
        <div x-show="step === 3" x-transition>
            <h2 class="text-2xl font-heading font-semibold text-hopono-blue-deeper mb-6 text-center">
                Your Details
            </h2>

            <!-- Summary -->
            <div class="bg-hopono-cream rounded-xl p-6 mb-8 max-w-lg mx-auto">
                <h3 class="font-heading font-semibold text-hopono-blue-deeper mb-2">Booking Summary</h3>
                <div class="text-sm text-gray-600 space-y-1">
                    <p><strong>Service:</strong> <span x-text="selectedServiceName"></span></p>
                    <p><strong>Date:</strong> <span x-text="selectedDate"></span></p>
                    <p><strong>Time:</strong> <span x-text="selectedTime"></span></p>
                    <p><strong>Price:</strong> &euro;<span x-text="selectedPrice"></span>
                        <span x-show="discountAmount > 0" class="text-green-600">
                            (-&euro;<span x-text="discountAmount.toFixed(2)"></span>)
                        </span>
                    </p>
                </div>
            </div>

            <form method="POST" action="{{ url_for('booking.confirm') }}" class="max-w-lg mx-auto space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="service_id" :value="selectedServiceId">
                <input type="hidden" name="date" :value="selectedDate">
                <input type="hidden" name="start_time" :value="selectedTime">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                    <input type="text" name="name" required
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-blue focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                    <input type="email" name="email" required
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-blue focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                    <input type="tel" name="phone" required placeholder="+357..."
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-blue focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Appointment Reminder</label>
                    <select name="reminder_preference"
                            class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-blue focus:border-transparent">
                        <option value="both">SMS & Email</option>
                        <option value="phone">SMS only</option>
                        <option value="email">Email only</option>
                    </select>
                </div>

                <!-- Coupon (unobtrusive) -->
                <div x-data="{ showCoupon: false }">
                    <button type="button" @click="showCoupon = !showCoupon"
                            class="text-sm text-gray-400 hover:text-hopono-blue transition">
                        Have a coupon code?
                    </button>
                    <div x-show="showCoupon" x-transition class="mt-2 flex gap-2">
                        <input type="text" name="coupon_code" x-model="couponCode" placeholder="Enter code"
                               class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-hopono-blue focus:border-transparent">
                        <button type="button" @click="checkCoupon()"
                                class="bg-hopono-cream text-hopono-blue-deeper px-4 py-2 rounded-lg text-sm font-medium hover:bg-hopono-gold/20 transition">
                            Apply
                        </button>
                    </div>
                    <p x-show="couponMessage" x-text="couponMessage" class="text-sm mt-1"
                       :class="couponValid ? 'text-green-600' : 'text-red-500'"></p>
                </div>

                <!-- GDPR -->
                <div class="pt-4 border-t border-gray-200">
                    <label class="flex items-start space-x-3">
                        <input type="checkbox" required
                               class="mt-1 rounded border-gray-300 text-hopono-blue focus:ring-hopono-blue">
                        <span class="text-sm text-gray-600">
                            I consent to HoPono Massage storing my personal data (name, email, phone) for
                            the purpose of managing my appointment and sending reminders. My data will be
                            handled in accordance with GDPR regulations and will not be shared with third parties. *
                        </span>
                    </label>
                </div>

                <div class="flex justify-between pt-4">
                    <button type="button" @click="step = 2" class="text-hopono-blue hover:text-hopono-blue-dark font-medium transition">
                        &larr; Back
                    </button>
                    <button type="submit"
                            class="bg-hopono-gold hover:bg-hopono-gold-light text-hopono-blue-deeper font-semibold px-8 py-3 rounded-full transition">
                        Confirm Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
function bookingApp() {
    return {
        step: 1,
        selectedServiceId: null,
        selectedServiceName: '',
        selectedDuration: 0,
        selectedPrice: 0,
        selectedDate: '',
        selectedTime: '',
        slots: [],
        loadingSlots: false,
        couponCode: '',
        couponMessage: '',
        couponValid: false,
        discountAmount: 0,

        get minDate() {
            const d = new Date();
            d.setDate(d.getDate() + 1);
            return d.toISOString().split('T')[0];
        },

        selectService(id, name, duration, price) {
            this.selectedServiceId = id;
            this.selectedServiceName = name;
            this.selectedDuration = duration;
            this.selectedPrice = price;
        },

        goToStep2() {
            if (this.selectedServiceId) {
                this.step = 2;
                this.selectedDate = '';
                this.selectedTime = '';
                this.slots = [];
            }
        },

        async fetchSlots() {
            if (!this.selectedDate || !this.selectedServiceId) return;
            this.loadingSlots = true;
            this.selectedTime = '';
            try {
                const resp = await fetch(`/book/slots?service_id=${this.selectedServiceId}&date=${this.selectedDate}`);
                const data = await resp.json();
                this.slots = data.slots || [];
            } catch (e) {
                this.slots = [];
            }
            this.loadingSlots = false;
        },

        async checkCoupon() {
            if (!this.couponCode) return;
            try {
                const resp = await fetch('/book/validate-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrf_token]').value
                    },
                    body: JSON.stringify({
                        code: this.couponCode,
                        service_id: this.selectedServiceId
                    })
                });
                const data = await resp.json();
                this.couponMessage = data.message;
                this.couponValid = data.valid;
                this.discountAmount = data.valid ? data.discount_amount : 0;
            } catch (e) {
                this.couponMessage = 'Error validating coupon.';
                this.couponValid = false;
            }
        }
    }
}
</script>
{% endblock %}
