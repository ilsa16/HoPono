{% extends "base.html" %}
{% block title %}Book an Appointment â€” HoPono Massage{% endblock %}

{% block content %}
<section class="relative py-16 overflow-hidden">
    <div class="absolute inset-0">
        <img src="{{ url_for('static', filename='images/services_header.jpg') }}" alt="" class="w-full h-full object-cover">
        <div class="absolute inset-0 bg-hopono-dark/90"></div>
    </div>
    <div class="relative max-w-4xl mx-auto px-4 text-center">
        <h1 class="text-3xl sm:text-4xl font-heading font-light text-white mb-2">Book Your Session</h1>
        <p class="text-white/50">Choose your treatment to get started</p>
    </div>
</section>

<section class="py-16 bg-hopono-dark" x-data="bookingApp()">
    <div class="max-w-4xl mx-auto px-4">

        <div class="flex items-center justify-center mb-12">
            <div class="flex items-center space-x-4 text-sm">
                <span class="flex items-center" :class="step >= 1 ? 'text-hopono-gold font-semibold' : 'text-white/30'">
                    <span class="w-8 h-8 rounded-full flex items-center justify-center mr-2 transition duration-300"
                          :class="step >= 1 ? 'bg-hopono-gold text-hopono-dark' : 'bg-white/10 text-white/30'">1</span>
                    Service
                </span>
                <div class="w-12 h-px transition duration-300" :class="step >= 2 ? 'bg-hopono-gold' : 'bg-white/10'"></div>
                <span class="flex items-center" :class="step >= 2 ? 'text-hopono-gold font-semibold' : 'text-white/30'">
                    <span class="w-8 h-8 rounded-full flex items-center justify-center mr-2 transition duration-300"
                          :class="step >= 2 ? 'bg-hopono-gold text-hopono-dark' : 'bg-white/10 text-white/30'">2</span>
                    Date & Time
                </span>
                <div class="w-12 h-px transition duration-300" :class="step >= 3 ? 'bg-hopono-gold' : 'bg-white/10'"></div>
                <span class="flex items-center" :class="step >= 3 ? 'text-hopono-gold font-semibold' : 'text-white/30'">
                    <span class="w-8 h-8 rounded-full flex items-center justify-center mr-2 transition duration-300"
                          :class="step >= 3 ? 'bg-hopono-gold text-hopono-dark' : 'bg-white/10 text-white/30'">3</span>
                    Your Details
                </span>
            </div>
        </div>

        <div x-show="step === 1" x-transition>
            <h2 class="text-2xl font-heading font-semibold text-white mb-6 text-center">
                Select Your Treatment
            </h2>

            <div x-show="!focusMode" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {% for service in services %}
                    <button
                            @click="enterFocusMode({{ service.id }})"
                            class="text-left bg-hopono-surface rounded-xl p-6 border border-white/5 transition duration-300 hover:shadow-lg hover:shadow-hopono-gold/5 hover:border-white/20 cursor-pointer group">
                        <h3 class="font-heading font-semibold text-white group-hover:text-hopono-gold transition duration-300">{{ service.name }}</h3>
                        <p class="text-hopono-gold text-sm font-medium">{{ service.subtitle }}</p>
                        <div class="flex justify-between items-center mt-3 text-sm">
                            <span class="text-hopono-gold font-semibold">&euro;{{ "%.0f"|format(service.price_eur) }}</span>
                            <span class="text-white/30">{{ service.duration_minutes }} min</span>
                        </div>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div x-show="focusMode" x-transition:enter="transition ease-out duration-400" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

                <button @click="focusMode = false; focusedServiceId = null; selectedServiceId = null" class="text-hopono-gold hover:text-hopono-gold-light text-sm font-medium mb-6 transition duration-300 flex items-center space-x-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    <span>All treatments</span>
                </button>

                <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,1fr)_minmax(0,1.2fr)_280px] gap-6 lg:gap-8">
                    <div class="relative overflow-hidden rounded-2xl bg-hopono-surface border border-white/5 aspect-[3/4] max-h-[480px]">
                        <template x-for="svc in allServices" :key="'img-'+svc.id">
                            <img x-show="svc.image" :src="'/static/images/services/' + svc.image"
                                 :alt="svc.name"
                                 class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500"
                                 :class="focusedServiceId === svc.id ? 'opacity-100' : 'opacity-0'">
                        </template>
                    </div>

                    <div class="flex flex-col justify-center">
                        <h3 class="text-2xl sm:text-3xl font-heading font-semibold text-white mb-1" x-text="focusedService?.name"></h3>
                        <p class="text-hopono-gold font-medium mb-4" x-text="focusedService?.subtitle"></p>
                        <p class="text-white/50 leading-relaxed mb-6 text-sm sm:text-base" x-text="focusedService?.desc"></p>

                        <div class="space-y-2 mb-6">
                            <div class="flex items-center space-x-3 text-sm">
                                <span class="w-1.5 h-1.5 rounded-full bg-hopono-gold flex-shrink-0"></span>
                                <span class="text-white/60"><span class="text-white/80 font-medium">Best for:</span> <span x-text="focusedService?.bestFor"></span></span>
                            </div>
                            <div class="flex items-center space-x-3 text-sm">
                                <span class="w-1.5 h-1.5 rounded-full bg-hopono-gold flex-shrink-0"></span>
                                <span class="text-white/60"><span class="text-white/80 font-medium">Pressure:</span> <span x-text="focusedService?.pressure"></span></span>
                            </div>
                            <div class="flex items-center space-x-3 text-sm">
                                <span class="w-1.5 h-1.5 rounded-full bg-hopono-gold flex-shrink-0"></span>
                                <span class="text-white/60"><span x-text="focusedService?.dur"></span> minutes</span>
                            </div>
                        </div>

                        <div class="flex items-center space-x-3 mb-6">
                            <span class="text-2xl font-heading font-bold text-white">&euro;<span x-text="focusedService?.price"></span></span>
                            <span class="text-white/30">&middot;</span>
                            <span class="text-white/40"><span x-text="focusedService?.dur"></span> min</span>
                        </div>

                        <button @click="confirmFocusSelection()"
                                class="bg-hopono-gold hover:bg-hopono-gold-light text-hopono-dark font-semibold px-10 py-3 rounded-full transition duration-300 transform hover:scale-105 shadow-lg shadow-hopono-gold/20 w-fit">
                            Continue
                        </button>
                    </div>

                    <div class="bg-hopono-surface border border-white/5 rounded-2xl p-3 max-h-[480px] overflow-y-auto">
                        <template x-for="svc in allServices" :key="'rail-'+svc.id">
                            <button @click="switchFocusedService(svc.id)"
                                    class="w-full text-left px-4 py-3 rounded-xl flex items-start justify-between gap-3 transition duration-300 mb-1"
                                    :class="focusedServiceId === svc.id ? 'bg-hopono-dark border border-hopono-gold/30' : 'border border-transparent hover:bg-hopono-dark/50'">
                                <div class="flex items-start space-x-3 min-w-0">
                                    <span class="w-2 h-2 rounded-full mt-2 flex-shrink-0 transition duration-300"
                                          :class="focusedServiceId === svc.id ? 'bg-hopono-gold' : 'bg-white/20'"></span>
                                    <div class="min-w-0">
                                        <div class="font-heading font-semibold text-sm transition duration-300"
                                             :class="focusedServiceId === svc.id ? 'text-white' : 'text-white/60'" x-text="svc.name"></div>
                                        <div class="text-xs transition duration-300"
                                             :class="focusedServiceId === svc.id ? 'text-hopono-gold' : 'text-white/30'" x-text="svc.subtitle"></div>
                                    </div>
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <div class="text-xs font-semibold"
                                         :class="focusedServiceId === svc.id ? 'text-hopono-gold' : 'text-white/40'">&euro;<span x-text="svc.price"></span></div>
                                    <div class="text-xs text-white/20" x-text="svc.dur + ' min'"></div>
                                </div>
                                <div x-show="focusedServiceId === svc.id" class="flex-shrink-0 mt-1">
                                    <svg class="w-4 h-4 text-hopono-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="step === 2" x-transition>
            <h2 class="text-2xl font-heading font-semibold text-white mb-6 text-center">
                Choose Your Date & Time
            </h2>
            <div class="max-w-md mx-auto">
                <label class="block text-sm font-medium text-white/60 mb-2">Select Date</label>
                <input type="date" x-model="selectedDate" @change="fetchSlots()"
                       :min="minDate"
                       class="w-full bg-hopono-surface border border-white/10 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-gold focus:border-transparent text-white">
            </div>

            <div x-show="loadingSlots" class="text-center mt-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-hopono-gold"></div>
                <p class="text-white/40 mt-2">Loading available times...</p>
            </div>

            <div x-show="selectedDate && !loadingSlots && slots.length > 0" class="mt-8">
                <p class="text-center text-white/50 mb-4">Available times for <span x-text="selectedDate" class="font-semibold text-white"></span></p>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 max-w-2xl mx-auto">
                    <template x-for="slot in slots" :key="slot">
                        <button @click="selectedTime = slot"
                                class="py-3 px-4 rounded-lg text-center font-medium transition duration-300 border"
                                :class="selectedTime === slot ? 'bg-hopono-gold text-hopono-dark border-hopono-gold' : 'bg-hopono-surface text-white/70 border-white/5 hover:border-hopono-gold/40'">
                            <span x-text="slot"></span>
                        </button>
                    </template>
                </div>
            </div>

            <div x-show="selectedDate && !loadingSlots && slots.length === 0" class="text-center mt-8">
                <p class="text-white/40">No available times for this date. Please try another day.</p>
            </div>

            <div class="flex justify-between mt-8 max-w-md mx-auto">
                <button @click="step = 1" class="text-hopono-gold hover:text-hopono-gold-light font-medium transition duration-300">
                    &larr; Back
                </button>
                <button @click="step = 3" :disabled="!selectedTime"
                        class="bg-hopono-gold hover:bg-hopono-gold-light text-hopono-dark font-semibold px-8 py-3 rounded-full transition duration-300 disabled:opacity-30 disabled:cursor-not-allowed transform hover:scale-105">
                    Continue
                </button>
            </div>
        </div>

        <div x-show="step === 3" x-transition>
            <h2 class="text-2xl font-heading font-semibold text-white mb-6 text-center">
                Your Details
            </h2>

            <div class="bg-hopono-surface border border-white/5 rounded-xl p-6 mb-8 max-w-lg mx-auto">
                <h3 class="font-heading font-semibold text-white mb-2">Booking Summary</h3>
                <div class="text-sm space-y-1">
                    <p class="text-white/50"><strong class="text-white/70">Service:</strong> <span x-text="selectedServiceName"></span></p>
                    <p class="text-white/50"><strong class="text-white/70">Date:</strong> <span x-text="selectedDate"></span></p>
                    <p class="text-white/50"><strong class="text-white/70">Time:</strong> <span x-text="selectedTime"></span></p>
                    <p class="text-white/50"><strong class="text-white/70">Price:</strong> &euro;<span x-text="selectedPrice"></span>
                        <span x-show="discountAmount > 0" class="text-green-400">
                            (-&euro;<span x-text="discountAmount.toFixed(2)"></span>)
                        </span>
                    </p>
                </div>
            </div>

            <form method="POST" action="{{ url_for('booking.confirm') }}" class="max-w-lg mx-auto space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="service_id" :value="selectedServiceId">
                <input type="hidden" name="date" :value="selectedDate">
                <input type="hidden" name="start_time" :value="selectedTime">

                <div>
                    <label class="block text-sm font-medium text-white/60 mb-1">Full Name *</label>
                    <input type="text" name="name" required
                           class="w-full bg-hopono-surface border border-white/10 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-gold focus:border-transparent text-white placeholder-white/20">
                </div>

                <div>
                    <label class="block text-sm font-medium text-white/60 mb-1">Email *</label>
                    <input type="email" name="email" required
                           class="w-full bg-hopono-surface border border-white/10 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-gold focus:border-transparent text-white placeholder-white/20">
                </div>

                <div>
                    <label class="block text-sm font-medium text-white/60 mb-1">Phone Number *</label>
                    <input type="tel" name="phone" required placeholder="+357..."
                           class="w-full bg-hopono-surface border border-white/10 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-gold focus:border-transparent text-white placeholder-white/20">
                </div>

                <div>
                    <label class="block text-sm font-medium text-white/60 mb-1">Appointment Reminder</label>
                    <select name="reminder_preference"
                            class="w-full bg-hopono-surface border border-white/10 rounded-lg px-4 py-3 focus:ring-2 focus:ring-hopono-gold focus:border-transparent text-white">
                        <option value="both">SMS & Email</option>
                        <option value="phone">SMS only</option>
                        <option value="email">Email only</option>
                    </select>
                </div>

                <div x-data="{ showCoupon: false }">
                    <button type="button" @click="showCoupon = !showCoupon"
                            class="text-sm text-white/30 hover:text-hopono-gold transition duration-300">
                        Have a coupon code?
                    </button>
                    <div x-show="showCoupon" x-transition class="mt-2 flex gap-2">
                        <input type="text" name="coupon_code" x-model="couponCode" placeholder="Enter code"
                               class="flex-1 bg-hopono-surface border border-white/10 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-hopono-gold focus:border-transparent text-white placeholder-white/20">
                        <button type="button" @click="checkCoupon()"
                                class="bg-white/5 border border-white/10 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-hopono-gold/20 hover:border-hopono-gold/30 transition duration-300">
                            Apply
                        </button>
                    </div>
                    <p x-show="couponMessage" x-text="couponMessage" class="text-sm mt-1"
                       :class="couponValid ? 'text-green-400' : 'text-red-400'"></p>
                </div>

                <div class="pt-4 border-t border-white/5">
                    <label class="flex items-start space-x-3">
                        <input type="checkbox" required
                               class="mt-1 rounded border-white/20 bg-hopono-surface text-hopono-gold focus:ring-hopono-gold">
                        <span class="text-sm text-white/40">
                            I consent to HoPono Massage storing my personal data (name, email, phone) for
                            the purpose of managing my appointment and sending reminders. My data will be
                            handled in accordance with GDPR regulations and will not be shared with third parties. *
                        </span>
                    </label>
                </div>

                <div class="flex justify-between pt-4">
                    <button type="button" @click="step = 2" class="text-hopono-gold hover:text-hopono-gold-light font-medium transition duration-300">
                        &larr; Back
                    </button>
                    <button type="submit"
                            class="bg-hopono-gold hover:bg-hopono-gold-light text-hopono-dark font-semibold px-8 py-3 rounded-full transition duration-300 transform hover:scale-105 shadow-lg shadow-hopono-gold/20">
                        Confirm Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
function bookingApp() {
    const services = [
        {% for service in services %}
        {
            id: {{ service.id }},
            name: {{ service.name|tojson }},
            subtitle: {{ service.subtitle|tojson }},
            desc: {{ service.description|tojson }},
            dur: {{ service.duration_minutes }},
            price: {{ service.price_eur|float }},
            image: {{ (service.image_filename or '')|tojson }},
            bestFor: {{ (service.best_for or '')|tojson }},
            pressure: {{ (service.pressure_level or '')|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    return {
        step: 1,
        focusMode: false,
        focusedServiceId: null,
        allServices: services,

        selectedServiceId: null,
        selectedServiceName: '',
        selectedDuration: 0,
        selectedPrice: 0,
        selectedDate: '',
        selectedTime: '',
        slots: [],
        loadingSlots: false,
        couponCode: '',
        couponMessage: '',
        couponValid: false,
        discountAmount: 0,

        get focusedService() {
            return this.allServices.find(s => s.id === this.focusedServiceId) || null;
        },

        enterFocusMode(serviceId) {
            this.focusedServiceId = serviceId;
            this.focusMode = true;
        },

        switchFocusedService(serviceId) {
            this.focusedServiceId = serviceId;
        },

        confirmFocusSelection() {
            const svc = this.focusedService;
            if (!svc) return;
            this.selectedServiceId = svc.id;
            this.selectedServiceName = svc.name;
            this.selectedDuration = svc.dur;
            this.selectedPrice = svc.price;
            this.step = 2;
            this.selectedDate = '';
            this.selectedTime = '';
            this.slots = [];
        },

        get minDate() {
            const d = new Date();
            d.setDate(d.getDate() + 1);
            return d.toISOString().split('T')[0];
        },

        selectService(id, name, duration, price) {
            this.selectedServiceId = id;
            this.selectedServiceName = name;
            this.selectedDuration = duration;
            this.selectedPrice = price;
        },

        goToStep2() {
            if (this.selectedServiceId) {
                this.step = 2;
                this.selectedDate = '';
                this.selectedTime = '';
                this.slots = [];
            }
        },

        async fetchSlots() {
            if (!this.selectedDate || !this.selectedServiceId) return;
            this.loadingSlots = true;
            this.selectedTime = '';
            try {
                const resp = await fetch(`/book/slots?service_id=${this.selectedServiceId}&date=${this.selectedDate}`);
                const data = await resp.json();
                this.slots = data.slots || [];
            } catch (e) {
                this.slots = [];
            }
            this.loadingSlots = false;
        },

        async checkCoupon() {
            if (!this.couponCode) return;
            try {
                const resp = await fetch('/book/validate-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrf_token]').value
                    },
                    body: JSON.stringify({
                        code: this.couponCode,
                        service_id: this.selectedServiceId
                    })
                });
                const data = await resp.json();
                this.couponMessage = data.message;
                this.couponValid = data.valid;
                this.discountAmount = data.valid ? data.discount_amount : 0;
            } catch (e) {
                this.couponMessage = 'Error validating coupon.';
                this.couponValid = false;
            }
        }
    }
}
</script>
{% endblock %}
